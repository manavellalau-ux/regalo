<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Regalo para Aymara üåº</title>
  <style>
    :root {
      --bg1:#0f0c29; --bg2:#302b63; --bg3:#24243e; --stage:#000; --gold:#f6c453;
      --yellow:#ffd54a; --yellow2:#ff9f00; --white:#fff; --muted:#b9c0d0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;color:var(--white);background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));overflow:hidden}
    .screen{position:absolute;inset:0;display:grid;place-items:center;padding:24px}
    #portada{z-index:2}
    .card{width:min(820px,94vw);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(8px);border-radius:24px;padding:28px;box-shadow:0 20px 50px rgba(0,0,0,.35);text-align:center;animation:floatIn .7s ease-out both}
    @keyframes floatIn{from{opacity:0;transform:translateY(10px) scale(.98)}to{opacity:1;transform:none}}
    h1{margin:0 0 10px;font-size:clamp(1.6rem,3vw,2.2rem)}
    .mensaje{text-align:left;line-height:1.6;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px 18px;margin:18px 0 24px}
    .btn{appearance:none;border:0;padding:14px 22px;font-weight:700;font-size:1rem;border-radius:12px;cursor:pointer;background:linear-gradient(135deg,var(--gold),var(--yellow));color:#2b1e08;box-shadow:0 10px 24px rgba(246,196,83,.35)}
    #escena{display:none;background:var(--stage)}
    .topbar{position:absolute;top:12px;width:100%;text-align:center;font-weight:800;letter-spacing:.5px;color:var(--yellow);text-shadow:0 0 18px rgba(255,223,122,.25);font-size:clamp(1.6rem,4.5vw,3rem)}
    canvas{width:min(920px,96vw);height:min(620px,64vh);max-width:100vw;background:transparent}
    @media(orientation:portrait){canvas{height:58vh}}
  </style>
</head>
<body>
  <!-- ===== Hoja 1: Portada ===== -->
  <section id="portada" class="screen">
    <div class="card">
      <h1>Este es un regalo de <span style="color:var(--gold)">Manavella Lautaro</span> para <span style="color:var(--gold)">Demay Aymara</span> üíõ</h1>
      <p>Hecho con mucho amor y con mis propias manos (de programador üòÑ).</p>
      <div class="mensaje">
        <p><strong>Mi amor</strong>, te amo m√°s que a nada en este mundo. S√© que no es la gran cosa, pero lo hice yo. Perd√≥n por a veces ser como soy; vos te merec√©s lo mejor porque sos la persona m√°s incre√≠ble que conoc√≠. Quiero decirte que te amo con toda el alma y que nunca cambies. üíõ</p>
      </div>
      <button class="btn" id="abrir">üíù Abrir regalo</button>
    </div>
  </section>

  <!-- ===== Hoja 2: Escena (Canvas) ===== -->
  <section id="escena" class="screen">
    <div class="topbar">¬°Feliz Primavera! üåº</div>
    <canvas id="lienzo" width="1200" height="740"></canvas>
  </section>

  <!-- Audio (la ruta se decide por JS para tolerar nombres con espacios) -->
  <audio id="cancion" preload="auto" playsinline></audio>
  <input type="file" id="pickAudio" accept="audio/*" style="display:none" />

  <script>
    const portada=document.getElementById('portada');
    const escena=document.getElementById('escena');
    const btn=document.getElementById('abrir');
    const lienzo=document.getElementById('lienzo');
    const ctx=lienzo.getContext('2d');
    const audio=document.getElementById('cancion');
    const pickAudio=document.getElementById('pickAudio');

    // Colores CSS resueltos (no usar var() dentro de Canvas)
    const cssVars=getComputedStyle(document.documentElement);
    const YELLOW=(cssVars.getPropertyValue('--yellow')||'#ffd54a').trim();
    const YELLOW2=(cssVars.getPropertyValue('--yellow2')||'#ff9f00').trim();

    // ====== Flor linda (Canvas) ======
    function drawPrettyFlower(ctx,{x,y,scale=1,outer=120,inner=46,petals=20,upto=null,open=1,c1='#fff4b5',c2=YELLOW,c3=YELLOW2,center1='#6f411f',center2='#2f1a0f',dots='#c89b4a',stem='#72d28a',drawStem=true}={}){
      const R0=outer*scale,r0=inner*scale;const R=R0*(0.35+0.65*open),r=r0*(0.35+0.65*open);const total=Math.max(1,petals|0);const limit=upto==null?total:Math.min(upto,total);const per=(Math.PI*2)/total;
      function petal(rot,a=1,grow=1,shadow=false){ctx.save();ctx.translate(x,y);ctx.rotate(rot);if(shadow){ctx.shadowColor='rgba(255,170,40,.28)';ctx.shadowBlur=14}ctx.beginPath();ctx.moveTo(0,0);ctx.bezierCurveTo(r*0.62*grow,-r*0.22*grow,R*0.70*grow,-R*0.38*grow,0,-R*grow);ctx.bezierCurveTo(-R*0.70*grow,-R*0.38*grow,-r*0.62*grow,-r*0.22*grow,0,0);const g=ctx.createLinearGradient(0,-R*grow,0,-r*0.15*grow);g.addColorStop(0,c1);g.addColorStop(0.55,c2);g.addColorStop(1,c3);ctx.globalAlpha=a;ctx.fillStyle=g;ctx.strokeStyle='rgba(0,0,0,.10)';ctx.lineWidth=.7;ctx.fill();ctx.shadowBlur=0;ctx.stroke();ctx.restore()}
      for(let i=0;i<limit;i++)petal(i*per+per/2,.58,1.06,true);for(let i=0;i<limit;i++)petal(i*per,1,1,false);
      const discR=(R0*.50)*Math.max(0,open*1.1-.45);if(discR>0){let g=ctx.createRadialGradient(x,y,discR*.25,x,y,discR);g.addColorStop(0,center1);g.addColorStop(1,center2);ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,discR,0,Math.PI*2);ctx.fill();g=ctx.createRadialGradient(x,y,0,x,y,discR*.7);g.addColorStop(0,'rgba(255,255,255,.08)');g.addColorStop(1,'rgba(255,255,255,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,discR,0,Math.PI*2);ctx.fill();ctx.fillStyle=dots;const step=10*scale;for(let yy=-discR*.8;yy<=discR*.8;yy+=step){for(let xx=-discR*.8;xx<=discR*.8;xx+=step){const px=x+xx,py=y+yy;if(xx*xx+yy*yy<=discR*discR*.62){ctx.beginPath();ctx.arc(px,py,2*scale,0,Math.PI*2);ctx.fill()}}}}
      if(drawStem&&open>.9){ctx.strokeStyle=stem;ctx.lineWidth=6*scale;ctx.beginPath();ctx.moveTo(x,y+10*scale);ctx.quadraticCurveTo(x-30*scale,y+60*scale,x-6*scale,y+210*scale);ctx.stroke()}
    }

    const CAPTION_TEXT='para la mas culona';
    const easeOutCubic=t=>1-Math.pow(1-t,3);
    let startTime=null,paused=false,accPause=0,tPause=0;const D_OPEN=2200,D_PETALS=2000; // ms

    function frame(ts){
      if(startTime===null)startTime=ts;const t=Math.max(0,ts-startTime-accPause);const open=Math.min(1,easeOutCubic(Math.min(1,t/D_OPEN)));
      const TOTAL_PETALOS=22;const upto=Math.round(Math.min(TOTAL_PETALOS,(t/D_PETALS)*TOTAL_PETALOS));
      ctx.clearRect(0,0,lienzo.width,lienzo.height);
      const OUTER=120,SCALE=1.30;const flowerX=lienzo.width/2,flowerY=lienzo.height/2-85;drawPrettyFlower(ctx,{x:flowerX,y:flowerY,scale:SCALE,petals:TOTAL_PETALOS,upto,open});
      // Texto claramente debajo de la flor
      const R=OUTER*SCALE*(0.35+0.65*open);const captionY=flowerY+R+160; // +160 px
      ctx.save();ctx.fillStyle='#d8d8d8';ctx.font='16px Poppins, system-ui, sans-serif';ctx.textAlign='center';ctx.fillText(CAPTION_TEXT,flowerX,captionY);ctx.restore();
      if(!paused&&(open<1||upto<TOTAL_PETALOS))requestAnimationFrame(frame);
    }

    function togglePause(){if(!paused){paused=true;tPause=performance.now()}else{paused=false;accPause+=performance.now()-tPause;requestAnimationFrame(frame)}}

    // ===== Abrir escena + M√∫sica (robusto para nombres con espacios) =====
    async function irAEscena(){
      portada.style.display='none';escena.style.display='grid';startTime=null;paused=false;accPause=0;requestAnimationFrame(frame);
      try{
        const candidates=['media/Flores Amarillas.mp3','media/flores_amarillas.mp3','media/Flores-Amarillas.mp3'];
        let played=false;for(const src of candidates){audio.pause();audio.src=encodeURI(src);audio.currentTime=0;audio.load();try{await audio.play();played=true;break}catch(_){}}
        if(!played)throw new Error('Ninguna ruta candidata funcion√≥');
      }catch(e){pickAudio.click()}
    }

    btn.addEventListener('click',irAEscena);
    lienzo.addEventListener('click',togglePause);

    // ===== Tests r√°pidos =====
    console.group('%cChecks','color:#ffd54a');
    console.assert(lienzo instanceof HTMLCanvasElement,'canvas no hallado');
    console.assert(irAEscena.constructor.name==='AsyncFunction','irAEscena no es async');
    console.assert(typeof drawPrettyFlower==='function','drawPrettyFlower falta');
    try{const g=ctx.createLinearGradient(0,0,10,0);g.addColorStop(.5,YELLOW);console.log('‚úÖ grad ok')}catch(e){console.assert(false,'‚ùå grad color')}
    // Caption suficientemente lejos
    (function(){const OUTER=120,SCALE=1.30,open=1;const flowerY=lienzo.height/2-85;const R=OUTER*SCALE*(0.35+0.65*open);const captionY=flowerY+R+160;console.assert(captionY>=flowerY+R+120,'Caption muy cerca')})();
    console.groupEnd();

    // Fallback selector de audio
    pickAudio.addEventListener('change',async()=>{const f=pickAudio.files?.[0];if(!f)return;try{const url=URL.createObjectURL(f);audio.pause();audio.src=url;audio.load();await audio.play()}catch(err){console.error('No se pudo reproducir el archivo elegido:',err)}});
  </script>
</body>
</html>
